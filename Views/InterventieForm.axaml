<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="https://github.com/avaloniaui/design"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             x:Class="Elumatec.Tijdregistratie.Views.InterventieForm"
             mc:Ignorable="d"
             d:DesignWidth="1000"
             d:DesignHeight="600">

    <UserControl.Styles>
        <Style Selector="TextBox.readonly-style">
            <Setter Property="Background" Value="#F5F5F5"/>
            <Setter Property="Cursor" Value="Arrow"/>
            <Setter Property="CaretBrush" Value="Transparent"/>
        </Style>
        <Style Selector="TextBox.readonly-style:focus /template/ Border#PART_BorderElement">
            <Setter Property="Background" Value="#F5F5F5"/>
        </Style>
        <Style Selector="TextBox.readonly-style:pointerover /template/ Border#PART_BorderElement">
            <Setter Property="Background" Value="#F5F5F5"/>
        </Style>
    </UserControl.Styles>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Top row: messages (center) + timer + username (right) -->
        <Grid Grid.Row="0" Margin="0,0,0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Warning/Status Messages at Center -->
            <StackPanel Grid.Column="0"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Spacing="10">
                
                <!-- Warning message with dynamic colors -->
                <Border Background="{Binding StatusBackground}"
                        BorderBrush="{Binding StatusBorderBrush}"
                        BorderThickness="1"
                        CornerRadius="4"
                        Padding="12,8"
                        IsVisible="{Binding StatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                    <TextBlock Text="{Binding StatusMessage}"
                               Foreground="{Binding StatusForeground}"
                               TextWrapping="Wrap"
                               MaxWidth="400"
                               TextAlignment="Center"/>
                </Border>

                <!-- PDF downloaded message -->
                <Border Background="#E8F5E9"
                        BorderBrush="#4CAF50"
                        BorderThickness="1"
                        CornerRadius="4"
                        Padding="12,8"
                        IsVisible="{Binding PdfDownloaded}">
                    <TextBlock Text="PDF gedownload"
                               Foreground="#2E7D32"
                               TextAlignment="Center"/>
                </Border>
            </StackPanel>

            <!-- Timer + username (right) -->
            <StackPanel Grid.Column="1"
                        Orientation="Vertical"
                        HorizontalAlignment="Right">
                <TextBlock Text="{Binding TimerDisplay}"
                           FontSize="24"
                           FontWeight="Bold"
                           HorizontalAlignment="Right"/>
                <TextBlock Text="{Binding Username}"
                           FontSize="14"
                           Opacity="0.7"
                           HorizontalAlignment="Right"/>
            </StackPanel>
        </Grid>

        <!-- Main content -->
        <Grid Grid.Row="1"
              ColumnDefinitions="3*,5*"
              ColumnSpacing="20">

            <!-- LEFT -->
            <StackPanel Grid.Column="0" Spacing="10">

                <StackPanel>
                    <TextBlock Text="Bedrijf" FontWeight="SemiBold"/>
    
                    <!-- AutoCompleteBox for searching bedrijven (only for new interventies) -->
                    <AutoCompleteBox 
                        ItemsSource="{Binding BedrijvenSuggestions}"
                        SelectedItem="{Binding SelectedBedrijf}"
                        FilterMode="Contains"
                        Watermark="Zoek bedrijf..."
                        IsVisible="{Binding !IsPrefilled}"
                        IsEnabled="{Binding !IsReadOnly}"
                        MinimumPrefixLength="1"
                        ValueMemberBinding="{Binding BedrijfNaam}">
                        <AutoCompleteBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel>
                                    <TextBlock Text="{Binding BedrijfNaam}" FontWeight="SemiBold"/>
                                    <TextBlock Text="{Binding Stad}" FontSize="11" Opacity="0.6"/>
                                </StackPanel>
                            </DataTemplate>
                        </AutoCompleteBox.ItemTemplate>
                    </AutoCompleteBox>
                    
                    <!-- Show selected bedrijf name when prefilled (read-only for existing interventies) -->
                    <TextBlock Text="{Binding Bedrijfsnaam}"
                               IsVisible="{Binding IsPrefilled}"
                               Padding="8"
                               Background="#F5F5F5"
                               FontSize="14"/>
                </StackPanel>

                <StackPanel>
                    <TextBlock Text="Machine" FontWeight="SemiBold"/>

                    <!-- AutoCompleteBox for searching Machines (only for new interventies) -->
                    <AutoCompleteBox 
                        ItemsSource="{Binding MachineSuggestions}"
                        SelectedItem="{Binding SelectedMachine}"
                        FilterMode="Contains"
                        Watermark="Zoek machine..."
                        IsVisible="{Binding !IsPrefilled}"
                        IsEnabled="{Binding !IsReadOnly}"
                        MinimumPrefixLength="1"
                        ValueMemberBinding="{Binding MachineNaam}">
                        <AutoCompleteBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel>
                                    <TextBlock Text="{Binding MachineNaam}" FontWeight="SemiBold"/>
                                </StackPanel>
                            </DataTemplate>
                        </AutoCompleteBox.ItemTemplate>
                    </AutoCompleteBox>
                    
                    <!-- Show selected Machine name when prefilled (read-only for existing interventies) -->
                    <TextBlock Text="{Binding Machine}"
                               IsVisible="{Binding IsPrefilled}"
                               Padding="8"
                               Background="#F5F5F5"
                               FontSize="14"/>
                </StackPanel>

                <StackPanel>
                    <TextBlock Text="Contactpersoon Naam" FontWeight="SemiBold"/>
                    
                    <TextBox Text="{Binding ContactpersoonNaam}"
                             IsReadOnly="{Binding IsReadOnly}"
                             Classes.readonly-style="{Binding IsReadOnly}"/>
                </StackPanel>

                <StackPanel>
                    <TextBlock Text="Contactpersoon Email" FontWeight="SemiBold"/>
                    <TextBox Text="{Binding ContactpersoonEmail}"
                             IsReadOnly="{Binding IsReadOnly}"
                             Classes.readonly-style="{Binding IsReadOnly}"/>
                </StackPanel>

                <StackPanel>
                    <TextBlock Text="Contactpersoon Telefoon" FontWeight="SemiBold"/>
                    <TextBox Text="{Binding ContactpersoonTelefoon}"
                             IsReadOnly="{Binding IsReadOnly}"
                             Classes.readonly-style="{Binding IsReadOnly}"/>
                </StackPanel>

                <StackPanel>
                    <TextBlock Text="Totale looptijd" FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding TotalTimeDisplay}"
                            FontSize="16"
                            Padding="8"
                            Background="#F5F5F5"/>
                </StackPanel>

                <!-- Previous Calls List -->
                <StackPanel IsVisible="{Binding PreviousCalls.Count}">
                    <TextBlock Text="Eerdere gesprekken" 
                               FontWeight="SemiBold" 
                               Margin="0,10,0,5"/>
                    
                    <ScrollViewer MaxHeight="180" 
                                  VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding PreviousCalls}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Button Command="{Binding $parent[UserControl].DataContext.LoadPreviousCallCommand}"
                                            CommandParameter="{Binding}"
                                            HorizontalAlignment="Stretch"
                                            HorizontalContentAlignment="Left"
                                            Margin="0,2"
                                            Padding="8"
                                            PointerEntered="CallButton_PointerEntered"
                                            PointerExited="CallButton_PointerExited">
                                        <StackPanel>
                                            <TextBlock Text="{Binding StartCall, StringFormat='{}{0:dd/MM/yyyy HH:mm}'}" 
                                                       FontWeight="SemiBold"
                                                       FontSize="12"/>
                                            <TextBlock Text="{Binding ExterneNotities}" 
                                                       TextWrapping="Wrap"
                                                       MaxWidth="250"
                                                       FontSize="11"
                                                       Opacity="0.7"
                                                       MaxLines="2"
                                                       TextTrimming="CharacterEllipsis"/>
                                        </StackPanel>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </StackPanel>

            </StackPanel>

            <!-- RIGHT -->
            <StackPanel Grid.Column="1" Spacing="20">

                <StackPanel>
                    <TextBlock Text="Interne notities" FontWeight="SemiBold"/>
                    <TextBox Text="{Binding InterneNotities}"
                             AcceptsReturn="True"
                             TextWrapping="Wrap"
                             Height="200"
                             IsReadOnly="{Binding IsReadOnly}"
                             Classes.readonly-style="{Binding IsReadOnly}"/>
                </StackPanel>

                <StackPanel>
                    <TextBlock Text="Externe notities" FontWeight="SemiBold"/>
                    <TextBox Text="{Binding ExterneNotities}"
                             AcceptsReturn="True"
                             TextWrapping="Wrap"
                             Height="200"
                             IsReadOnly="{Binding IsReadOnly}"
                             Classes.readonly-style="{Binding IsReadOnly}"/>
                </StackPanel>

            </StackPanel>

        </Grid>

        <!-- Bottom right buttons -->
        <StackPanel Grid.Row="2"
                    HorizontalAlignment="Right"
                    Spacing="8">

            <!-- Buttons row -->
            <StackPanel Orientation="Horizontal"
                        HorizontalAlignment="Right"
                        Spacing="10"
                        VerticalAlignment="Bottom">

                <Button Content="Annuleren"
                        Command="{Binding CancelCommand}"
                        Background="#F44336"
                        Foreground="White"
                        Padding="12,8"/>

                <Button Content="Opslaan"
                        Command="{Binding StopAndSaveCommand}"
                        Background="#4CAF50"
                        Foreground="White"
                        Padding="12,8"/>

                <Button Content="Afronden &amp; PDF maken"
                        Command="{Binding DownloadPdfCommand}"
                        Background="#4CAF50"
                        Foreground="White"
                        Padding="12,8"/>

            </StackPanel>

        </StackPanel>

        <!-- Hover Info Overlay -->
        <Border Grid.Row="0" Grid.RowSpan="3"
                IsVisible="{Binding IsHoverInfoVisible}"
                Background="#CC000000"
                HorizontalAlignment="Center"
                VerticalAlignment="Top"
                Margin="0,100,0,0"
                Padding="20"
                CornerRadius="8"
                MaxWidth="500"
                BoxShadow="0 4 20 2 #40000000"
                IsHitTestVisible="False">
            <StackPanel Spacing="12" DataContext="{Binding HoveredCall}">
                <TextBlock Text="Gespreksdetails" 
                           FontSize="18" 
                           FontWeight="Bold"
                           Foreground="White"
                           HorizontalAlignment="Center"/>
                
                <Separator Background="#40FFFFFF"/>
                
                <StackPanel Spacing="8">
                    <StackPanel>
                        <TextBlock Text="Datum" 
                                   FontSize="11" 
                                   Foreground="#B0FFFFFF" 
                                   FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding StartCall, StringFormat='{}{0:dd/MM/yyyy}'}" 
                                   FontSize="14" 
                                   Foreground="White"/>
                    </StackPanel>
                    
                    <StackPanel>
                        <TextBlock Text="Tijd" 
                                   FontSize="11" 
                                   Foreground="#B0FFFFFF" 
                                   FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding StartCall, StringFormat='{}{0:HH:mm}'}" 
                                   FontSize="14" 
                                   Foreground="White"/>
                    </StackPanel>
                    
                    <StackPanel>
                        <TextBlock Text="Interne notities" 
                                   FontSize="11" 
                                   Foreground="#B0FFFFFF" 
                                   FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding InterneNotities}" 
                                   TextWrapping="Wrap" 
                                   FontSize="14" 
                                   Foreground="White"
                                   MaxHeight="100"/>
                    </StackPanel>
                    
                    <StackPanel>
                        <TextBlock Text="Externe notities" 
                                   FontSize="11" 
                                   Foreground="#B0FFFFFF" 
                                   FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding ExterneNotities}" 
                                   TextWrapping="Wrap" 
                                   FontSize="14" 
                                   Foreground="White"
                                   MaxHeight="100"/>
                    </StackPanel>
                </StackPanel>
            </StackPanel>
        </Border>

    </Grid>
</UserControl>
